rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Core Philosophy:
     * This ruleset enforces a two-tiered security model. The primary model is strict
     * user ownership, where members can only access their own data. The secondary
     * model is a global admin role, which grants privileged read/write access
     * across the database for administrative purposes.
     *
     * Data Structure:
     * - /members/{memberId}: A member's private profile and data. The {memberId} is
     *   the user's Authentication UID.
     * - /members/{memberId}/payments/{paymentId}: A subcollection containing a
     *   member's payment history, inheriting ownership from its parent.
     * - /states, /districts, /constituencies: Top-level collections for geographical
     *   data. This data is publicly readable to populate UI elements but is only
     *   writable by administrators.
     * - /admins/{adminId}: A special collection used as a lookup table for roles. The
     *   existence of a document with an ID matching a user's UID grants them
     *   admin privileges.
     *
     * Key Security Decisions:
     * - User data is private: A user can only access the document tree under
     *   /members/{their_own_uid}. Listing all members is restricted to admins.
     * - Admin role: An 'admins' collection provides a secure and performant way
     *   to manage global administrators without embedding roles in JWTs.
     * - Public data separation: Geographical data is separated into its own
     *   collections to allow for public read access without exposing private user
     *   information.
     * - Writes to the 'admins' collection are disabled from the client to prevent
     *   privilege escalation. Admin roles must be managed from the Firebase Console
     *   or a trusted server environment.
     */

    // --------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * This is the foundation of the user ownership model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the currently authenticated user has admin privileges.
     * Admin status is granted if a document with the user's UID exists in the /admins collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    /**
     * A combined check to see if the user is either the owner of the resource
     * or an administrator.
     */
    function isOwnerOrAdmin(userId) {
      return isOwner(userId) || isAdmin();
    }

    /**
     * Checks if the document being accessed already exists.
     * CRITICAL for all update and delete operations to prevent unintended writes.
     */
    function isExistingDoc() {
      return resource != null;
    }

    /**
     * A combined check for update/delete operations on user-owned documents.
     * Verifies that the document exists AND the user is either the owner or an admin.
     */
    function isExistingOwnerOrAdmin(userId) {
      return isOwnerOrAdmin(userId) && isExistingDoc();
    }


    // --------------------------------------------------------------------------
    // Collection Rules (Firestore)
    // --------------------------------------------------------------------------

    match /members/{memberId} {
      allow get: if isOwnerOrAdmin(memberId);
      allow list: if isAdmin();
      allow create: if isOwner(memberId) && request.resource.data.id == memberId;
      allow update: if isExistingOwnerOrAdmin(memberId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwnerOrAdmin(memberId);

      match /payments/{paymentId} {
        allow get: if isOwnerOrAdmin(memberId);
        allow list: if isOwnerOrAdmin(memberId);
        allow create: if isOwner(memberId) && request.resource.data.memberId == memberId;
        allow update: if isExistingOwnerOrAdmin(memberId) && request.resource.data.memberId == resource.data.memberId;
        allow delete: if isExistingOwnerOrAdmin(memberId);
      }
    }

    match /states/{stateId} {
      allow read, list: if true;
      allow write: if isAdmin();
    }

    match /districts/{districtId} {
      allow read, list: if true;
      allow write: if isAdmin();
    }

    match /constituencies/{constituencyId} {
      allow read, list: if true;
      allow write: if isAdmin();
    }

    match /admins/{adminId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create, update, delete: if false; // Managed via Console/backend
    }
  }
}

service firebase.storage {
  match /b/{bucket}/o {
    
    // Allow public read access to journey caravan images and gallery images
    match /caravan/{allPaths=**} {
      allow read: if true;
    }
     match /gallery/{allPaths=**} {
      allow read: if true;
    }

    // Allow users to upload their own profile photo
    match /profile_photos/{userId}/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Allow users to upload payment proofs into their own folder
    match /payment_proofs/{userId}/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
